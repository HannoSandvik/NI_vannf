# Summary of the data flow

Norway has two different frameworks within which the ecological status of freshwater and coastal water systems is assessed and reported.
One is the so-called [Nature Index for Norway](https://www.naturindeks.no/) ("**NI**", hereafter).
The other is EU's [Water Framework Directive](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX:32000L0060) ("**WFD**"), or, more specifically, its Norwegian implementation (_[vannforskriften](https://lovdata.no/dokument/SF/forskrift/2006-12-15-1446)_, "**VF**").
All measurements made in connection with the latter are archived in a specialised database called _[vannmiljø](https://vannmiljo.miljodirektoratet.no/)_.
The WFD indicators used in Norway, including their definitions, measurement and class boundaries, are described in official [guidelines](https://www.vannportalen.no/veiledere/klassifiseringsveileder/) (plus [supplement](https://www.vannportalen.no/veiledere/02-2018-vedlegg-til-veileder-klassifisering-av-miljotilstanden-i-vann.pdf), both in Norwegian).

Several WFD indicators have been included in the NI as well.
These indicators should ideally give compatible descriptions in both frameworks.
To ensure this, and based on previous analyses and recommendations ([Schartau et al. 2016](http://hdl.handle.net/11250/2384734), [Gundersen et al. 2018](http://hdl.handle.net/11250/2584222)), Sandvik ([2019](http://hdl.handle.net/11250/2631056)) has described a dataflow from the WFD to the NI.
The same dataflow may be relevant when WFD data are to be used in connection with an Ecosystem Condition Accounting (see [Fremstad et al. 2023](https://hdl.handle.net/11250/3104185)).
The dataflow is implemented in the [**R** code](../R/) of this GitHub repository and briefly summarised on this very page.

As the relevant authorities have not made their data available in machine-readable format, several datasets need to be downloaded manually prior to the dataflow:

* The **measurements** of WFD parameters and the information on **water localities** (_vannlokaliteter_) are available from the _[vannmiljø](https://vannmiljo.miljodirektoratet.no/)_ database.
* The information (mainly typology) on the **water bodies** (_vannforekomster_) of Norway is available from the _[vann-nett](https://vann-nett.no/portal/)_ database.
* More detailed characteristics of the **lakes** of Norway (if needed) are available from the _[innsjødatabase](https://www.nve.no/kart/kartdata/vassdragsdata/innsjodatabase/)_.

These datasets and their websites are available in Norwegian only, and a full documentation of the dataflow in English has therefore not been prioritised.
However, the dataflow can be summarised in 16 steps ([Sandvik 2019](http://hdl.handle.net/11250/2631056)):

1. _Reading measurements from the [vannmiljø](https://vannmiljo.miljodirektoratet.no/) database._ This step requires the dataset to be downloaded manually. Afterwards, the function [`lesMaalinger`](../R/lesMaalinger.R) ("readMeasurements") is used to prepare the dataset for the following steps.
2. _Removing measurements that have been taken outside the reporting period for NI._ Steps 2 to 15 are carried out by the function [`fraVFtilNI`](../R/fraVFtilNI.R) ("fromWFDtoNI").
3. _Removing measurements with values that lie outside the interval for which the indicator is defined._ The _vannmiljø_ database contains several values that are incompatible with the definition of the indicator. These must have been mismeasured or misreported and need to be excluded. In addition, it is possible (and recommended) to exclude other measurements taken by the same operator at the same date.
4. _Identifying the water locality for each measurement._ Measurements taken in an unknown water locality are excluded. (A list of known water localities needs to have been read using the function [`lesVannlokaliteter`](../R/lesVannlokaliteter.R) ["readWaterLocalities"].)
5. _Identifying the water body for each water locality._ Measurements taken in an unknown water body are excluded. (A list of known water bodies needs to have been read using the function [`lesVannforekomster`](../R/lesVannforekomster.R) ["readWaterBodies"].)
6. _Identifying the lake number for each water body (only relevant for lakes)._ The function [`oppdaterVannforekomster`](../R/oppdaterVannforekomster.R) ("updateWaterBodies") ensures that information about lake water bodies, e.g. their area and altitude, is updated and potentially corrected using the [innsjødatabase](https://www.nve.no/kart/kartdata/vassdragsdata/innsjodatabase/). (The latter needs to have been read using the function [`lesInnsjodatabasen`](../R/lesInnsjodatabasen.R) ["readLakeDatabase"]).
7. _Removing measurements that are taken in a water body category for which the indicator is not defined._ For example, if a WFD indicator that is defined for rivers is measured in a lake, this measurement is excluded.
8. _Removing measurements that are taken in a water body type for which the indicator is not defined._ For example, if a WFD indicator that is defined for lime-poor lakes is measured in a lime-rich lake, this measurement is excluded.
9. _Removing measurements for reporting periods with too little data._ A certain minimum sample size is needed to estimate the status for a given reporting period. If the actual sample size is smaller than this threshold, the respective reporting period is omitted, and the measurements taken during this period are excluded.
10. _Scaling measurements to untruncated nEQR values ("mEQR" values)._ According to the WFD and the [Norwegian WFD guidelines](https://www.vannportalen.no/veiledere/klassifiseringsveileder/) (ch. 3.5), measurements of WFD indicators are transformed into so-called **nEQR** values ("normalised Ecological Quality Ratios") between 0 and 1. This transformation includes a truncation, where measurements that are better than the upper boundary of high ecological status are assigned an nEQR value of 1, and  measurements that are poorer than the lower boundary of bad ecological status are assigned an nEQR value of 0. Truncation, however, destroys information about variation that is important for estimating the uncertainty of NI scores. Therefore, Sandvik ([2019](http://hdl.handle.net/11250/2631056), pp. 13–15) has suggested that the dataflow from WFD to NI should be based on values that are _scaled and transformed but not truncated_, referring to these values as **mEQR** values ("m" for "modified" &ndash; or for the letter [step] before "n"). (According to this suggestion, measurements are first _scaled_ so that values of 0 correspond to the lower boundary of bad ecological status, and values of 1 correspond to the upper boundary of high ecological status; the values obtained are than _transformed_ so that the remaining boundaries between status classes correspond to the normative definitions provided for the respective indicator. The resulting mEQR values can be exchanged between WFD and NI. If the mEQR values are then _truncated_ in a later step [_after_ the estimation of uncertainty of NI scores], they are again equal to nEQR values. It is thus only the order of steps that is changed, from truncation&ndash;scaling&ndash;transformation to scaling&ndash;transformation&ndash;truncation. The crucial difference is that this change allows the full variability of measurements to be exploited by the NI. The scaling and transformation is carried out by the function [`mEQR`](../R/mEQR.R).)
11. _Fitting a linear model to the measurements._ A linear model is fitted to the mEQR values, with explanatory variables being reporting periods, typology factors and surveillance activities. _Typology factors_ are described in the [Norwegian WFD guidelines](https://www.vannportalen.no/veiledere/klassifiseringsveileder/) (ch. 3.3 and 3.4) and include altitudinal zone, size class, lime content and organic matter content, among others. _Surveillance activities_ describe the management target of each measurement (see [vannmiljø](https://vannmiljokoder.miljodirektoratet.no/activity)). Measurements taken under the WFD can be expected to be biased towards poorer status than the average. Therefore, Sandvik ([2019](http://hdl.handle.net/11250/2631056), pp. 17–19) has proposed to weight each measurement by the representativeness of its surveillance activity, so as to partially correct for the bias in the data available. Model selection is based on AIC ([Akaikes Information Criterion](https://en.wikipedia.org/wiki/Akaike_information_criterion)).
12. _Averaging measurements taken in the same water body._ If more than one measurement has been taken in the same water body within the same reporting period, the unweighted mean of these measurements is used to represent the water body body.
13. _Extrapolating mEQR values to water bodies that lack data._ If no measurement has been taken in a water body, the most likely indicator value is predicted for this water body, based on the model fitted in step 11.
14. _Using simulations to estimate confidence and prediction intervals._ Based on the model fitted in step 11 and a re-sampling procedure, the uncertainty surrounding the estimates obtained in steps 12 and 13 is quantified using confidence intervals for water bodies that have been sampled, and prediction intervals for water bodies that have not been sampled.
15. _Aggregating estimates geographically._ The values obtained for water bodies are aggregated for administrative units (municipalities, counties, regions and/or the whole country). For lake water bodies, aggregation takes the form of averages weighted by lake area (ensuring that different size classes contribute equally to the average; cf. [Sandvik 2019](http://hdl.handle.net/11250/2631056), pp. 21–23). For river and coastal water bodies, aggregation currently has to apply unweighted averageing. (When the lengths of river water bodies and the areas of coastal water bodies are made available in the respective databases in the future, their averages should be weighted as well.) This step is the last one carried out by the function [`fraVFtilNI`](../R/fraVFtilNI.R).
16. _Averaging the aggregated values for different water body catgegories._ This step is only applicable to the few WFD indicators that are defined for both lakes and rivers, where the combined values are obtained by unweighted averages. This is accomplished by the function [`kombiner`](../R/kombiner.R) ("combine").

Once these steps have been carried out, the values obtained can be uploaded to the NI database.
This can be done using the function [`oppdaterNImedVF`](../R/oppdaterNImedVF.R) ("updateNIusingWFD";
this function requires the [NIcalc](https://github.com/NINAnor/NIcalc) package).

Further explanations are [available in Norwegian]().
