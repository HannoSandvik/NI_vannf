# Summary of the data flow

Norway has two different frameworks within which the ecological status of freshwater and coastal water systems is assessed and reported.
One is the so-called [Nature Index for Norway](https://www.naturindeks.no/) ("NI", hereafter).
The other is EU's [Water Framework Directive](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX:32000L0060) ("WFD"), or, more specifically, its Norwegian implementation (_[vannforskriften](https://lovdata.no/dokument/SF/forskrift/2006-12-15-1446)_, "VF").
All measurements made in connection with the latter are archived in a specialised database called _[vannmiljø](https://vannmiljo.miljodirektoratet.no/)_.
Several WFD indicators have been included in the NI as well.
The [Norwegian Environmental Agency](https://www.miljodirektoratet.no/) has expressed the aim that these indicators give compatible descriptions in both frameworks.
Based on previous analyses and recommendations ([Schartau et al. 2016](http://hdl.handle.net/11250/2384734), [Gundersen et al. 2018](http://hdl.handle.net/11250/2584222)), Sandvik ([2019](http://hdl.handle.net/11250/2631056)) has described a dataflow from the WFD to the NI.
The same dataflow may be relevant when WFD data are to be used in connection with an Ecosystem Condition Accounting (see [Fremstad et al. 2023](https://hdl.handle.net/11250/3104185)).
This dataflow is implemented in the [**R** code](../R/) of this GitHub repository and shortly summarised on this very page.

As the relevant authorities have not made their data available in machine-readable format, several datasets need to be downloaded manually prior to the dataflow:

* The **measurements** of WFD parameters and the information on **water localities** (_vannlokaliteter_) are available from the _[vannmiljø](https://vannmiljo.miljodirektoratet.no/)_ database.
* The information (mainly typology) on the **water bodies** (_vannforekomster_) of Norway is available from the _[vann-nett](https://vann-nett.no/portal/)_ database.
* More detailed characteristics of the **lakes** of Norway (if needed) are available from the _[innsjødatabase](https://www.nve.no/kart/kartdata/vassdragsdata/innsjodatabase/)_.

These datasets and their websites are available in Norwegian only, and a full documentation of the dataflow in English has therefore not been prioritised.
However, the dataflow can be summarised in 16 steps ([Sandvik 2019](http://hdl.handle.net/11250/2631056)):

1. _Reading measurements from the [vannmiljø](https://vannmiljo.miljodirektoratet.no/) database._ This step requires the dataset to be downloaded manually. Afterwards, the function [`lesMaalinger`](lesMaalinger.R) ("readMeasurements") is used to prepare the dataset for the following steps.
2. _Removing measurements that have been taken outside the reporting period for NI._ Steps 2 to 15 are carried out by the function [`fraVFtilNI`](fraVFtilNI.R) ("fromWFDtoNI").
3. _Removing measurements with values that lie outside the interval for which the indicator is defined._ The _vannmiljø_ database contains several values that are incompatible with the definition of the indicator. These must have been mismeasured or misreported and need to be excluded. In addition, it is possible (and recommended) to exclude other measurements taken by the same operator at the same date.
4. _Identifying the water locality for each measurement._ Measurements taken in an unknown water locality need to be excluded. (A list of known water localities needs to have been read using the function [`lesVannlokaliteter`](lesVannlokaliteter.R) ["readWaterLocalities"].)
5. _Identifying the water body for each water locality._ Measurements taken in an unknown water body need to be excluded. (A list of known water bodies needs to have been read using the function [`lesVannforekomster`](lesVannforekomster.R) ["readWaterBodies"].)
6. _Identifying the lake number for each water body (only relevant for lakes)._ The function [`oppdaterVannforekomster`](oppdaterVannforekomster.R) ("updateWaterBodies") ensures that information about lake water bodies, e.g. their area and altitude, is updated and potentially corrected using the [innsjødatabase](https://www.nve.no/kart/kartdata/vassdragsdata/innsjodatabase/). (The latter needs to have been read using the function [`lesInnsjodatabasen`](lesInnsjodatabasen.R) ["readLakeDatabase"]).
9. _Målinger som er tatt i en vannkategori som indikatoren ikke er definert for, fjernes._ Når f.eks. en vannforskriftsparameter som er definert for elver, blir målt i en innsjø, blir denne målinga ekskludert. 
10. _Målinger som er tatt i en vanntype der indikatorens klassegrenser ikke er definert, fjernes._ Når f.eks. en vannforskriftsparameter som er definert for kalkfattige innsjøer, blir målt i en kalkrik innsjø, blir denne målinga ekskludert.
11. _Hvis antallet målinger i en rapporteringsperiode er for lite, fjernes målingene._ Det trengs et visst minstetall av målinger for å estimere tilstanden i en rapporteringsperiode. Hvis det er tatt færre målinger, utgår denne rapporteringsperioden og de respektive målingene.
12. _Måleverdiene skaleres til ikke-trunkerte nEQR-verdier («mEQR-verdier»)._ Vannforskriften regner om målinger til såkalte **nEQR-verdier** («normaliserte økologiske kvalitetskvotienter»), som har verdier mellom 0 og 1. Denne skaleringa innebærer trunkering av måleverdier som er bedre enn referansetilstanden, til 1 og av måleverdier som er dårligere enn nedre grense for «svært dårlig tilstand», til 0 ([veileder 02:2018](https://www.vannportalen.no/veiledere/klassifiseringsveileder/), kap. 3.5). Slik trunkering skjuler imidlertid kunnskap om variasjon, som er viktig for naturindeksen. Sandvik ([2019](http://hdl.handle.net/11250/2631056), s. 13–15) har derfor foreslått at dataflyten mellom vannforskriften og naturindeks bør baseres på EQR-verdier som er _skalert, men ikke trunkert_, og kaller slike verdier for _mEQR-verdier_ (se [utdypende forklaring](mEQR.md)).
13. _Det tilpasses en lineær modell til målingene._ Variasjonen mellom målingene forsøkes forklart gjennom en lineær modell som bruker rapporteringsperioder, typologifaktorer og overvåkingsaktiviteter som forklaringsvariabler. _Typologifaktorer_ omfatter vannforekomstenes klimasone, størrelse, alkalitet, humusinnhold og lignende (se [veileder 02:2018](https://www.vannportalen.no/veiledere/klassifiseringsveileder/), kap. 3.3 og 3.4). Disse samvarierer ofte systematisk med indikatorverdiene og må derfor tas høyde for. _Overvåkingsaktiviteter_ definerer målingens forvaltningsmessige formål (se [vannmiljø](https://vannmiljokoder.miljodirektoratet.no/activity)), og målinger med dårlig tilstand må antas å være overrepresentert i datamaterialet som er samla inn i vannforskriftsammenheng. Det er derfor foreslått en metode for å vekte de ulike overvåkingsaktivitetene for deres representativitet, for på denne måten å kunne korrigere for noe av skjevheten som ligger i datamaterialet ([Sandvik 2019](http://hdl.handle.net/11250/2631056), s. 17–19). Modellseleksjonen er basert på AIC ([Akaikes informasjonskriterium](https://en.wikipedia.org/wiki/Akaike_information_criterion)).
14. _Uvekta gjennomsnitt av målinger innafor en vannforekomst bestemmer dennes verdi._ Hvis det er tatt flere målinger i samme vannforekomst i samme rapporteringsperiode, settes verdien for denne vannforekomsten til det uvekta gjennomsnittet av disse målingene.
15. _Ekstrapolering av mEQR-verdier til vannforekomster som det ikke fins målinger fra._ Hvis det ikke tatt målinger i en vannforekomst, predikeres den mest trolige verdien basert på modellen som ble tilpassa i trinn 11.
16. _Simulering basert på konfidens-/prediksjonsintervaller for å kvantifisere usikkerheten._ Basert på den tilpassa modellen kvantifiseres usikkerheten ved hjelp av en simulering som genererer slumptall basert på konfidensintervaller for vannforekomster som det er tatt målinger i, og basert på prediksjonsintervaller for vannforekomster som det ikke er tatt målinger i.
17. _Aggregering av vannforekomstenes verdier for geografiske enheter som gjennomsnitt._ Vannforekomstenes verdier aggregeres for kommuner, fylker, landsdeler og/eller hele landet. For innsjøvannforekomstene er aggregeringa basert på gjennomsnitt som er vekta med innsjøenes areal, noe som innebærer at alle størrelsesklasser bidrar noenlunde likt til gjennomsnittet (se [Sandvik 2019](http://hdl.handle.net/11250/2631056), s. 21–23). For elve- og kystvannforekomster må aggregeringa inntil videre baserere seg på uvekta gjennomsnitt, fordi deres areal eller lengde per i dag ikke er tilgjengelig fra [vann-nett](https://vann-nett.no/portal/). Dette trinnet er det siste som gjennomføres av funksjonen [`fraVFtilNI`](fraVFtilNI.md).
18. _Uvekta gjennomsnitt av de aggregerte verdiene for ulike vannkategorier._ Dette trinnet er bare relevant for de få vannforskriftsparameterne som er definert for både innsjøer og elver, og det gjennomføres av funksjonen [`kombiner`](kombiner.md). Forutsatt at funksjonen `fraVFtilNI` har blitt kjørt separat for innsjøer og elver, kombinerer `kombiner` utmatingene fra begge kjøringene.

Further explanations are [available in Norwegian]().
